{{- if not .ALB.GetAliases}}
LoadBalancerDNSAlias:
  Metadata:
    'aws:copilot:description': 'The default alias record for the application load balancer'
  Type: AWS::Route53::RecordSetGroup
  Properties:
    HostedZoneId:
      Fn::ImportValue:
        !Sub "${AppName}-${EnvName}-HostedZone"
    Comment: !Sub "LoadBalancer alias for service ${WorkloadName}"
    RecordSets:
    - Name:
        !Join
          - '.'
          - - !Ref WorkloadName
            - Fn::ImportValue:
                !Sub "${AppName}-${EnvName}-SubDomain"
            - ""
      Type: A
      AliasTarget:
        HostedZoneId: !GetAtt EnvControllerAction.PublicLoadBalancerHostedZone
        DNSName: !GetAtt EnvControllerAction.PublicLoadBalancerDNSName
{{- else}}
{{- range $hostedZoneID, $aliases := .ALB.HostedZoneAliases}}
LoadBalancerDNSAlias{{$hostedZoneID}}:
  Metadata:
    'aws:copilot:description': 'Alias records for the application load balancer in hosted zone {{$hostedZoneID}}'
  Type: AWS::Route53::RecordSetGroup
  Properties:
    HostedZoneId: {{$hostedZoneID}}
    Comment: !Sub "LoadBalancer aliases for service ${WorkloadName} in hosted zone {{$hostedZoneID}}"
    RecordSets:
    {{- range $alias := $aliases}}
      - Name: {{quote $alias}}
        Type: A
        AliasTarget:
          {{- if eq $.WorkloadType "Backend Service"}}
          HostedZoneId: !GetAtt EnvControllerAction.InternalLoadBalancerHostedZone
          DNSName: !GetAtt EnvControllerAction.InternalLoadBalancerDNSName
          {{- else}}
          HostedZoneId: !GetAtt EnvControllerAction.PublicLoadBalancerHostedZone
          DNSName: !GetAtt EnvControllerAction.PublicLoadBalancerDNSName
          {{- end}}
    {{- end}}
{{- end}}
{{- end}}

{{- range $listener := .ALB.Listener}}
HTTPSRulePriorityAction{{logicalIDSafe $listener.Path}}:
  Metadata:
    'aws:copilot:description': 'A custom resource assigning priority for HTTPS listener rules'
  Type: Custom::RulePriorityFunction
  Properties:
    ServiceToken: !GetAtt RulePriorityFunction.Arn
    RulePath: {{$listener.Path}}
    {{- if eq $.WorkloadType "Backend Service" }}
    ListenerArn: !GetAtt EnvControllerAction.InternalHTTPSListenerArn
    {{- else}}
    ListenerArn: !GetAtt EnvControllerAction.HTTPSListenerArn
    {{- end}}

HTTPRuleWithDomainPriorityAction{{logicalIDSafe $listener.Path}}:
  Metadata:
    'aws:copilot:description': 'A custom resource assigning priority for HTTP listener rules'
  Type: Custom::RulePriorityFunction
  Properties:
    ServiceToken: !GetAtt RulePriorityFunction.Arn
    RulePath: {{$listener.Path}}
    {{- if eq $.WorkloadType "Backend Service"}}
    ListenerArn: !GetAtt EnvControllerAction.InternalHTTPListenerArn
    {{- else}}
    ListenerArn: !GetAtt EnvControllerAction.HTTPListenerArn
    {{- end}}

HTTPListenerRuleWithDomain{{logicalIDSafe $listener.Path}}:
  Metadata:
    {{- if $.ALB.HTTPRedirect}}
    'aws:copilot:description': 'An HTTP listener rule that redirects HTTP to HTTPS'
    {{- else}}
    'aws:copilot:description': 'An HTTP listener rule for forwarding HTTP traffic to your tasks'
    {{- end}}
  Type: AWS::ElasticLoadBalancingV2::ListenerRule
  Properties:
    Actions:
      {{- if $.ALB.HTTPRedirect}}
      - Type: redirect
        RedirectConfig:
          Protocol: HTTPS
          Port: 443
          Host: "#{host}"
          Path: "/#{path}"
          Query: "#{query}"
          StatusCode: HTTP_301
      {{- else}}
      - TargetGroupArn: !Ref {{ if eq $listener.Path "/"}} TargetGroupDefaultPath {{ else }}TargetGroup{{ logicalIDSafe $listener.Path }}{{ end }}
        Type: forward
      {{- end}}
    Conditions:
      {{- if $listener.AllowedSourceIps }}
      - Field: 'source-ip'
        SourceIpConfig:
          Values:
            {{- range $sourceIP := $listener.AllowedSourceIps}}
            - {{$sourceIP}}
            {{- end}}
      {{- end}}
      {{- if $listener.Aliases }}
      - Field: 'host-header'
        HostHeaderConfig:
          Values: {{ fmtSlice (quoteSlice $listener.Aliases) }}
      {{- else }}
      - Field: 'host-header'
        HostHeaderConfig:
          Values:
            - Fn::Join:
              - '.'
              - - !Ref WorkloadName
                - Fn::ImportValue:
                    !Sub "${AppName}-${EnvName}-SubDomain"
      {{- end}}
      - Field: 'path-pattern'
        PathPatternConfig:
          Values:
            {{- if eq $listener.Path "/"}}
            - /*
            {{- else }}
            - /{{ $listener.Path }}
            - /{{ $listener.Path }}/*
            {{- end }}
    {{- if eq $.WorkloadType "Backend Service"}}
    ListenerArn: !GetAtt EnvControllerAction.InternalHTTPListenerArn
    {{- else}}
    ListenerArn: !GetAtt EnvControllerAction.HTTPListenerArn
    {{- end}}
    Priority: !GetAtt HTTPRuleWithDomainPriorityAction{{logicalIDSafe $listener.Path}}.Priority

HTTPSListenerRule{{logicalIDSafe $listener.Path}}:
  Metadata:
    'aws:copilot:description': 'An HTTPS listener rule for forwarding HTTPS traffic to your tasks'
  Type: AWS::ElasticLoadBalancingV2::ListenerRule
  Properties:
    Actions:
      - TargetGroupArn: !Ref {{ if eq $listener.Path "/"}} TargetGroupForDefaultPath {{ else }} TargetGroupFor{{ logicalIDSafe $listener.Path }} {{ end }}
        Type: forward
    Conditions:
      {{- if $listener.AllowedSourceIps}}
      - Field: 'source-ip'
        SourceIpConfig:
          Values:
          {{- range $sourceIP := $listener.AllowedSourceIps}}
            - {{$sourceIP}}
          {{- end}}
      {{- end}}
      {{- if $listener.Aliases }}
      - Field: 'host-header'
        HostHeaderConfig:
          Values: {{ fmtSlice (quoteSlice $listener.Aliases) }}
      {{- else }}
      - Field: 'host-header'
        HostHeaderConfig:
          Values:
            - Fn::Join:
              - '.'
              - - !Ref WorkloadName
                - Fn::ImportValue:
                    !Sub "${AppName}-${EnvName}-SubDomain"
      {{- end}}
      - Field: 'path-pattern'
        PathPatternConfig:
          Values:
          {{- if eq $listener.Path "/" }}
            - /*
          {{- else }}
            - /{{ $listener.Path }}
            - /{{ $listener.Path }}/*
          {{- end }}
    {{- if eq $.WorkloadType "Backend Service"}}
    ListenerArn: !GetAtt EnvControllerAction.InternalHTTPSListenerArn
    {{- else}}
    ListenerArn: !GetAtt EnvControllerAction.HTTPSListenerArn
    {{- end}}
    Priority: !GetAtt HTTPSRulePriorityAction{{logicalIDSafe $listener.Path }}.Priority
{{- end }}