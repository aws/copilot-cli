- Name: !Ref WorkloadName
  Image: !Ref ContainerImage
{{include "secrets" . | indent 2}}
  Environment:
{{include "envvars-common" . | indent 2}}
{{include "envvars-container" . | indent 2}}
  EnvironmentFiles:
    - !If
      - HasEnvFile
      - Type: s3
        Value: !Ref EnvFileARN
      - !Ref AWS::NoValue
{{include "logconfig" . | indent 2}}
{{include "image-overrides" . | indent 2}}
{{- if .Storage -}}
{{include "mount-points" . | indent 2}}
{{- end -}}
{{- if .DockerLabels}}
  DockerLabels:{{range $name, $value := .DockerLabels}}
    {{$name | printf "%q"}}: {{$value | printf "%q"}}{{end}}
{{- end}}
{{- if .DependsOn}}
  DependsOn:
  {{- range $name, $conditionFrom := .DependsOn}}
    - Condition: {{$conditionFrom}}
      ContainerName: {{$name}}
  {{- end}}
{{- end}}
{{- if eq .WorkloadType "Load Balanced Web Service"}}
  PortMappings:
    {{- range $portMapping := .PortMappings}}
    - ContainerPort: {{$portMapping.ContainerPort}}
    {{- if eq $.HTTPTargetContainer.Name $.WorkloadName}}
      Name: {{ (portMappingName $portMapping.Name $portMapping.ContainerPort) }}
    {{- end}}
    {{- end}}
{{- if .NLB}} {{ $nlbListener := .NLB.Listener }} 
  {{- if and (eq $nlbListener.TargetContainer .WorkloadName) (ne $nlbListener.TargetPort .NLB.MainContainerPort)}}
  {{/*No need to add additional port if the target port is the same as image port*/}}
    - ContainerPort: {{$nlbListener.TargetPort}}
      Protocol: {{if eq $nlbListener.Protocol "UDP"}}udp{{else}}tcp{{end}}
  {{- end}}
{{- end}}
{{- end}} {{/* end if eq .WorkloadType "Load Balanced Web Service"*/}}
{{- if eq .WorkloadType "Backend Service"}}
{{- if and (eq .HTTPTargetContainer.Name .WorkloadName) .PortMappings}}
  PortMappings:
        {{- range $portMapping := .PortMappings}}
      - ContainerPort: {{$portMapping.ContainerPort}}
        Name: {{ (portMappingName $portMapping.Name $portMapping.ContainerPort) }}
        {{- end}}
{{- end}}
{{- end}}
{{- if .HealthCheck}}
  HealthCheck:
    Command: {{quoteSlice .HealthCheck.Command | fmtSlice}}
    Interval: {{.HealthCheck.Interval}}
    Retries: {{.HealthCheck.Retries}}
    StartPeriod: {{.HealthCheck.StartPeriod}}
    Timeout: {{.HealthCheck.Timeout}}
{{- end}}
{{- if and .Storage .Storage.ReadonlyRootFS}}
  ReadonlyRootFilesystem: {{.Storage.ReadonlyRootFS}}
{{- end}}
{{- if .CredentialsParameter}}
  RepositoryCredentials:
    CredentialsParameter: {{.CredentialsParameter}}
{{- end}}