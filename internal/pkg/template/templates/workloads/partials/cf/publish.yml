{{- if .Publish}}
{{- range $topic := .Publish.Topics}}
{{logicalIDSafe $topic.Name}}SNSTopic:
  Metadata:
    'aws:copilot:description': {{ if or $topic.FIFOTopicConfig }} 'A FIFO SNS topic to broadcast {{$topic.Name}} events' {{ else}} 'A SNS topic to broadcast {{$topic.Name}} events'{{ end}}
  Type: AWS::SNS::Topic
  Properties:
    {{- if $topic.FIFOTopicConfig }}
    TopicName: !Sub '${AWS::StackName}-{{$topic.Name}}.fifo'
    FifoTopic: true
    {{- if $topic.FIFOTopicConfig.ContentBasedDeduplication }}
    ContentBasedDeduplication: {{$topic.FIFOTopicConfig.ContentBasedDeduplication}}
    {{- end }}
    {{- else}}
    TopicName: !Sub '${AWS::StackName}-{{$topic.Name}}'
    {{- end}}
    KmsMasterKeyId: 'alias/aws/sns'

{{logicalIDSafe $topic.Name}}SNSTopicPolicy:
  Type: AWS::SNS::TopicPolicy
  DependsOn: {{logicalIDSafe $topic.Name}}SNSTopic
  Properties:
    Topics:
      - !Ref {{logicalIDSafe $topic.Name}}SNSTopic
    PolicyDocument:
      Version: '2012-10-17'
      Statement:
        - Effect: Allow
          Principal:
            AWS: !Sub 'arn:${AWS::Partition}:iam::${AWS::AccountId}:root'
          Action:
            - sns:Subscribe
          Resource: !Ref {{logicalIDSafe $topic.Name}}SNSTopic
          Condition:
            StringEquals:
              "sns:Protocol": "sqs"
{{- end}}
{{- end}}