
# Observability

## Getting Started
Copilot can deploy the AWS OpenTelemetry Collector as a [sidecar](./sidecars.en.md) by setting the following in your manifest:
```yaml
observability:
  tracing: awsxray
```

Copilot will then deploy the AWS OpenTelemetry Collector using the [ECS X-Ray configuration](https://github.com/aws-observability/aws-otel-collector/blob/main/config/ecs/ecs-xray.yaml), which does the following:
- Receives [OpenTelemetry Protocol](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md) telemetry data on default ports `:4317` (GRPC) and `:4318` (HTTP)
- Adds [ECS](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor#amazon-ecs) and [EC2](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor#aws-ec2) resource information to traces generated by your service
- [Batches](https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/batchprocessor) traces before exporting them to X-Ray
- [Exports](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awsxrayexporter) traces to AWS X-Ray

## Instrumenting Your Service
Instrumenting your service to send telemetry data is done through [language specific SDKs](https://opentelemetry.io/docs/instrumentation/). Examples are provided there for each language supported by OpenTelemetry. You can also view documentation provided for AWS Distro for OpenTelemetry [here](https://aws-otel.github.io/docs/introduction).

### Including Trace Logs
_Note that this is not applicable to Request-Driven Web Services_

Because Copilot configures the ECS resource detector on the collector, traces generated by your service will include the log group your service is logging to. Then, if you include the trace ID in your logs, they will show up along with the trace in CloudWatch. This can be helpful for understanding and debugging a trace.

X-Ray [formats their trace IDs](https://docs.aws.amazon.com/xray/latest/devguide/xray-api-sendingdata.html#xray-api-traceids) a little [differently than OpenTelemetry](https://opentelemetry.io/docs/reference/specification/trace/api/#spancontext), so you'll need a function like this to take an OpenTelemetry trace ID and format it correctly for X-Ray:
```js
function getXRayTraceId(span) {
  const id = span.spanContext().traceId;
  if (id.length < 9) {
		return id;
	}

	return "1-" + id.substring(0, 8) + "-" + id.substring(8);
}
```

Then, you can include the X-Ray trace ID in your logs like so:
```js
console.log("[%s] A useful log message", getXRayTraceId(span));
```

[comment]: # (annotate logs)

## Viewing Traces in AWS X-Ray Console
After you have instrumented your service and deployed it using Copilot, you're ready to view traces from your app! Depending on how you've instrumented your service, you will likely need to send a few requests to it before traces will appear in the AWS console.

First, open the CloudWatch console, and click on `X-Ray traces`/`Service map` in the menu. Here you can see a visual map of your services interacting:
[comment]: # (todo image)

Next, you can view details of a specific trace by clicking on `X-Ray traces`/`Traces` in the menu and selecting a trace from the list.

In this example, you can see the service, `js-copilot-observability`, running some internal express.js middleware, and then calling `s3:listBuckets`:
[comment]: # (todo image)

---

[comment]: # (below is the original version, with xray sdk support)

---

# Observability

# Getting Started

Copilot can deploy the AWS OpenTelemetry Collector as a [sidecar](./sidecars.en.md) by setting the following in your manifest:
```yaml
observability:
  tracing: awsxray
```

Copilot will then deploy the AWS OpenTelemetry Collector using its [default configuration](https://github.com/aws-observability/aws-otel-collector/blob/main/config.yaml), which does the following:
- Receives [OpenTelemetry Protocol](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md) telemetry data on port `:4317` (GRPC) and `:55681` (HTTP)
- Receives AWS X-Ray traces (generated by the [AWS X-Ray SDK](https://docs.aws.amazon.com/xray/latest/devguide/xray-instrumenting-your-app.html#xray-instrumenting-xray-sdk)) on `:2000`
- Batches traces and metrics before exporting them
- Exports traces to AWS X-Ray and metrics to AWS CloudWatch Metrics

# Instrumenting Your Service
Instrumenting your service to send telemetry data is done through language-specific SDKs.
You can learn how to instrument a service in your language of choice with Open Telemetry SDKs [here](https://opentelemetry.io/docs/instrumentation/), or with AWS X-Ray SDKs [here](https://docs.aws.amazon.com/xray/latest/devguide/xray-instrumenting-your-app.html#xray-instrumenting-xray-sdk).

// TODO below

If your service is using AWS SDKs to interact with other AWS Services, you can instrument those API calls 

# Viewing Traces in AWS X-Ray Console
After you have instrumented your service and deployed it using Copilot, you're ready to view traces from your app! Depending on how you've instrumented your service, you will likely need to send a few requests to it before traces will appear in the AWS console.

First, open the CloudWatch console, and click on `X-Ray traces`/`Service map` in the menu. Here you can see a visual map of your services interacting:

// TODO IMG

Next, click on `Traces` in the menu. Here you can view traces generated by your service, and look at details about a speicifc trace:

// TODO IMG
