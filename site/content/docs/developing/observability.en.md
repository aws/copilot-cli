# Observability

## Getting Started
Copilot can deploy the AWS OpenTelemetry Collector as a [sidecar](./sidecars.en.md) by setting the following in your manifest:
```yaml
observability:
  tracing: awsxray
```

Copilot will then deploy the AWS OpenTelemetry Collector using the [ECS X-Ray configuration](https://github.com/aws-observability/aws-otel-collector/blob/main/config/ecs/ecs-xray.yaml), which does the following:
- Receives [OpenTelemetry Protocol](https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md) telemetry data on default ports `:4317` (GRPC) and `:4318` (HTTP)
- Adds [ECS](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor#amazon-ecs) and [EC2](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor#aws-ec2) resource information to traces generated by your service
- [Batches](https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/batchprocessor) traces before exporting them to X-Ray
- [Exports](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/awsxrayexporter) traces to AWS X-Ray

## Instrumenting Your Service
Instrumenting your service to send telemetry data is done through [language specific SDKs](https://opentelemetry.io/docs/instrumentation/). 
Examples are provided in OpenTelemetry's documentation for each supported language.
You can also view documentation and examples provided by [AWS Distro for OpenTelemetry](https://aws-otel.github.io/docs/introduction).

### Including Trace Logs
_This section is not applicable to Request-Driven Web Services_

Because Copilot configures the ECS resource detector on the collector, traces generated by your service will include the log group your service is logging to.
Then, if you include the trace ID in your logs, logs associated with a trace will show up along with the trace in CloudWatch.
This can be helpful for understanding and debugging a trace.

X-Ray [formats their trace IDs](https://docs.aws.amazon.com/xray/latest/devguide/xray-api-sendingdata.html#xray-api-traceids) a little [differently than OpenTelemetry](https://opentelemetry.io/docs/reference/specification/trace/api/#spancontext), so you'll need a function like this to take an OpenTelemetry trace ID and format it correctly for X-Ray:
```js
function getXRayTraceId(span) {
	const id = span.spanContext().traceId;
	if (id.length < 9) {
		return id;
	}

	return "1-" + id.substring(0, 8) + "-" + id.substring(8);
}
```

Then, you can include the X-Ray trace ID in your logs like so:
```js
console.log("[%s] A useful log message", getXRayTraceId(span));
```

## Viewing Traces in AWS X-Ray Console
After you have instrumented your service and deployed it using Copilot, you're ready to view traces from your service!
Depending on how you've instrumented your service, you will likely need to send a few requests to it before traces will appear in the AWS console.

First, open the CloudWatch console, and click on `X-Ray traces/Service map` in the menu. Here you can see a visual map of services interacting:
![X-Ray Service Map](https://user-images.githubusercontent.com/10566468/166560753-f0911f85-a88c-4af8-b008-9aa7e9c25e2f.png)

Next, you can view details of a specific trace by clicking on `X-Ray traces/Traces` in the menu and selecting a trace from the list.

In this example, you can see a service, `js-copilot-observability`, running some internal [Express](https://expressjs.com/) middleware, and then using the [AWS SDK for Javascript](https://aws.amazon.com/sdk-for-javascript/) to call `s3:listBuckets`:
![X-Ray Trace Details](https://user-images.githubusercontent.com/10566468/166560878-fb40a67e-3e78-48db-908a-b5ec3ef95fd8.png)